import React, { useState, useEffect } from 'react';
import axios from 'axios';
import VulnerabilityCard from '../common/VulnerabilityCard';

const VulnerabilityProgress = () => {
  const [categories, setCategories] = useState([]);
  const [progress, setProgress] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');

  useEffect(() => {
    fetchProgress();
  }, []);

  const fetchProgress = async () => {
    try {
      // A01: IDOR vulnerability in the API
      const [categoriesRes, progressRes] = await Promise.all([
        axios.get('/api/progress/categories'),
        axios.get('/api/progress/summary/1')  // User ID hardcoded
      ]);
      
      setCategories(categoriesRes.data);
      setProgress(progressRes.data);
    } catch (err) {
      setError('Failed to load progress data');
    } finally {
      setLoading(false);
    }
  };

  const markCompleted = async (categoryId, vulnerabilityName) => {
    try {
      // A01: IDOR vulnerability in the API
      await axios.post('/api/progress/complete', {
        categoryId,
        vulnerabilityName
      });
      fetchProgress();
    } catch (err) {
      setError('Failed to update progress');
    }
  };

  const resetProgress = async () => {
    try {
      // A01: IDOR vulnerability
      await axios.post('/api/progress/reset', {
        userId: 1  // Using the same hardcoded user ID as in fetchProgress
      });
      fetchProgress();
      setSuccess('Progress reset successfully');
    } catch (err) {
      setError('Failed to reset progress');
    }
  };

  if (loading) return <div>Loading...</div>;

  return (
    <div className="card mb-4">
      <div className="card-header">
        <h3>Vulnerability Progress Tracking</h3>
      </div>
      <div className="card-body">
        {error && <div className="alert alert-danger">{error}</div>}
        {success && <div className="alert alert-success">{success}</div>}

        <button 
          className="btn btn-danger mb-3"
          onClick={resetProgress}
        >
          Reset Progress
        </button>

        <div className="row">
          {Object.entries(categories).map(([id, name]) => (
            <div key={id} className="col-md-6 mb-4">
              <VulnerabilityCard
                category={name}
                description={`Exploit ${name} vulnerabilities to complete this category`}
                status={progress.some(p => p.category === id && p.completed) ? 'active' : 'inactive'}
                onComplete={() => markCompleted(id, 'example_vulnerability')}
              />
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

export default VulnerabilityProgress;